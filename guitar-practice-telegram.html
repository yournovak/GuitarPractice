<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üé∏ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ì–∏—Ç–∞—Ä–Ω–æ–π –ü—Ä–∞–∫—Ç–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .dark-theme { background: linear-gradient(to bottom right, #1a1a2e, #16213e) !important; color: #e0e0e0; }
        .dark-theme .bg-white { background: #2d2d2d !important; color: #e0e0e0 !important; }
        .dark-theme .bg-gray-50 { background: #383838 !important; color: #e0e0e0 !important; }
        .dark-theme .bg-gray-100 { background: #404040 !important; color: #e0e0e0 !important; }
        .dark-theme .from-amber-50, .dark-theme .from-orange-50, .dark-theme .from-purple-50, .dark-theme .from-blue-50, .dark-theme .from-green-50, .dark-theme .from-red-50, .dark-theme .from-indigo-50, .dark-theme .from-yellow-100, .dark-theme .to-orange-100 { background: #3a3a3a !important; }
        .dark-theme .bg-purple-50, .dark-theme .bg-orange-50, .dark-theme .bg-blue-50, .dark-theme .bg-indigo-50, .dark-theme .bg-green-50, .dark-theme .bg-teal-50, .dark-theme .bg-gray-500 { background: #3a3a3a !important; color: #e0e0e0 !important; }
        .dark-theme .text-gray-700, .dark-theme .text-gray-800, .dark-theme .text-gray-900 { color: #e0e0e0 !important; }
        .dark-theme .text-gray-600 { color: #b0b0b0 !important; }
        .dark-theme .text-gray-500 { color: #999 !important; }
        .dark-theme .border-gray-200, .dark-theme .border-gray-300 { border-color: #555 !important; }
        .dark-theme input, .dark-theme textarea { background: #383838 !important; color: #e0e0e0 !important; border-color: #555 !important; }
        .dark-theme .border { border-color: #555 !important; }
        .dark-theme .bg-gradient-to-r { background: #3a3a3a !important; }
        .dark-theme h1 { background: linear-gradient(to right, #a78bfa, #fb923c) !important; -webkit-background-clip: text !important; background-clip: text !important; color: transparent !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const tg = window.Telegram?.WebApp || { CloudStorage: null, initDataUnsafe: { user: {} } };
        if (tg.expand) tg.expand();

        const GuitarPracticeApp = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [practiceData, setPracticeData] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [showAddForm, setShowAddForm] = useState(false);
            const [currentTab, setCurrentTab] = useState('calendar');
            const [darkTheme, setDarkTheme] = useState(false);
            const [learnedSongs, setLearnedSongs] = useState([]);
            const [toLearnSongs, setToLearnSongs] = useState([]);
            const [notes, setNotes] = useState([]);
            const [dailyQuote, setDailyQuote] = useState('');
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState({ username: '', avatar: '', registrationDate: new Date().toISOString(), lastLogin: new Date().toISOString() });
            const [friends, setFriends] = useState([]);
            const [friendRequests, setFriendRequests] = useState([]);
            const [searchFriendName, setSearchFriendName] = useState('');
            const [viewingFriend, setViewingFriend] = useState(null);
            const [selectedAchievement, setSelectedAchievement] = useState(null);
            const [editingNote, setEditingNote] = useState(null);

            const categories = {
                techniques: { name: '–¢–µ—Ö–Ω–∏–∫–∞', color: 'bg-orange-500', icon: '‚ö°' },
                improvisation: { name: '–ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è', color: 'bg-purple-500', icon: 'üé∏' },
                theory: { name: '–¢–µ–æ—Ä–∏—è', color: 'bg-green-500', icon: 'üìö' },
                songs: { name: '–ò–≥—Ä–∞ –ø–µ—Å–µ–Ω', color: 'bg-pink-500', icon: 'üéµ' },
                earTraining: { name: '–†–∞–∑–≤–∏—Ç–∏–µ —Å–ª—É—Ö–∞', color: 'bg-blue-500', icon: 'üëÇ' },
                other: { name: '–ü—Ä–æ—á–µ–µ', color: 'bg-gray-500', icon: 'üéº' }
            };

            const subcategories = {
                techniques: ['–†–∏—Ç–º–∏–∫–∞ –∏ –±–æ–∏', '–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–π —à—Ç—Ä–∏—Ö', '–î–∞—É–Ω—Å—Ç—Ä–æ–∫ –∏ –≥–∞–ª–æ–ø—ã', '–õ–µ–≥–∞—Ç–æ', '–í–∏–±—Ä–∞—Ç–æ –∏ –±–µ–Ω–¥—ã', '–°–≤–∏–ø', '–§–∏–Ω–≥–µ—Ä—Å—Ç–∞–π–ª', '–î—Ä—É–≥–æ–µ'],
                improvisation: ['–ò–≥—Ä–∞ –ø–æ–¥ –º–∏–Ω—É—Å–æ–≤–∫–∏', '–ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è –Ω–∞ –ø–µ—Å–Ω–∏', '–†–∞–±–æ—Ç–∞ —Å –¥–∏–Ω–∞–º–∏–∫–æ–π'],
                theory: ['–ò–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤', '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞', '–ê–Ω–∞–ª–∏–∑ –≥–∞—Ä–º–æ–Ω–∏–∏', '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∏—Ñ–∞'],
                songs: ['–†–∞–∑–±–æ—Ä –ø–µ—Å–Ω–∏', '–ò–≥—Ä–∞ –∑–Ω–∞–∫–æ–º–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞'],
                earTraining: ['–ü–æ–¥–±–æ—Ä –Ω–∞ —Å–ª—É—Ö', '–ü–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤', '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–æ–≤', '–ü—Ä–æ–ø–µ–ª –º–µ–ª–æ–¥–∏—é –∏ –ø–æ–¥–æ–±—Ä–∞–ª –µ–µ –Ω–∞ –≥–∏—Ç–∞—Ä–µ'],
                other: ['–ù–∞–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Å–µ–Ω', '–†–µ–ø–µ—Ç–∏—Ü–∏—è –≤ –≥—Ä—É–ø–ø–µ', '–ó–≤—É–∫–æ–∑–∞–ø–∏—Å—å', '–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ']
            };

            const motivationalQuotes = ["–ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ç–µ–±—è –∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É.", "–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –±–µ—Ä—ë—à—å –≥–∏—Ç–∞—Ä—É, –∏–≥—Ä–∞–π –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑. ‚Äî Eric Clapton", "–£ —Ç–µ–±—è –≤—Å–µ–≥–æ 12 –Ω–æ—Ç. –î–µ–ª–∞–π —Å –Ω–∏–º–∏ —á—Ç–æ —Ö–æ—á–µ—à—å. ‚Äî Eddie Van Halen", "–ö —á—ë—Ä—Ç—É –ø—Ä–∞–≤–∏–ª–∞. –ï—Å–ª–∏ –∑–≤—É—á–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ - –∑–Ω–∞—á–∏—Ç —Ç–∞–∫ –∏ –µ—Å—Ç—å. ‚Äî Eddie Van Halen", "–†–∞—Å—Å–ª–∞–±—å—Å—è. –ë—É–¥—å —Å–æ–±–æ–π. –ò–≥—Ä–∞–π –º–Ω–æ–≥–æ. ‚Äî Joe Satriani"];

            useEffect(() => {
                const loadData = async () => {
                    const telegramUser = tg.initDataUnsafe?.user;
                    if (telegramUser) setUserProfile(prev => ({ ...prev, username: telegramUser.username || telegramUser.first_name || '–ì–∏—Ç–∞—Ä–∏—Å—Ç', avatar: telegramUser.photo_url || '' }));
                    
                    if (tg.CloudStorage) {
                        tg.CloudStorage.getItems(['practiceData', 'learnedSongs', 'toLearnSongs', 'darkTheme', 'userProfile', 'friends', 'friendRequests', 'notes'], (error, result) => {
                            if (!error && result) {
                                if (result.practiceData) setPracticeData(JSON.parse(result.practiceData));
                                if (result.learnedSongs) setLearnedSongs(JSON.parse(result.learnedSongs));
                                if (result.toLearnSongs) setToLearnSongs(JSON.parse(result.toLearnSongs));
                                if (result.darkTheme) setDarkTheme(JSON.parse(result.darkTheme));
                                if (result.userProfile) setUserProfile(prev => ({ ...prev, ...JSON.parse(result.userProfile), lastLogin: new Date().toISOString() }));
                                if (result.friends) setFriends(JSON.parse(result.friends));
                                if (result.friendRequests) setFriendRequests(JSON.parse(result.friendRequests));
                                if (result.notes) setNotes(JSON.parse(result.notes));
                            }
                            setLoading(false);
                        });
                    } else {
                        ['practiceData', 'learnedSongs', 'toLearnSongs', 'darkTheme', 'userProfile', 'friends', 'notes'].forEach(key => {
                            const data = localStorage.getItem(key);
                            if (data) {
                                if (key === 'practiceData') setPracticeData(JSON.parse(data));
                                else if (key === 'learnedSongs') setLearnedSongs(JSON.parse(data));
                                else if (key === 'toLearnSongs') setToLearnSongs(JSON.parse(data));
                                else if (key === 'darkTheme') setDarkTheme(JSON.parse(data));
                                else if (key === 'userProfile') setUserProfile(JSON.parse(data));
                                else if (key === 'friends') setFriends(JSON.parse(data));
                                else if (key === 'notes') setNotes(JSON.parse(data));
                            }
                        });
                        setLoading(false);
                    }
                };
                loadData();
                setDailyQuote(motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]);
            }, []);

            useEffect(() => { if (!loading) { if (tg.CloudStorage) tg.CloudStorage.setItem('practiceData', JSON.stringify(practiceData)); else localStorage.setItem('practiceData', JSON.stringify(practiceData)); } }, [practiceData, loading]);
            useEffect(() => { if (!loading) { if (tg.CloudStorage) tg.CloudStorage.setItem('darkTheme', JSON.stringify(darkTheme)); else localStorage.setItem('darkTheme', JSON.stringify(darkTheme)); if (darkTheme) document.body.classList.add('dark-theme'); else document.body.classList.remove('dark-theme'); } }, [darkTheme, loading]);
            useEffect(() => { if (!loading) { if (tg.CloudStorage) tg.CloudStorage.setItem('learnedSongs', JSON.stringify(learnedSongs)); else localStorage.setItem('learnedSongs', JSON.stringify(learnedSongs)); } }, [learnedSongs, loading]);
            useEffect(() => { if (!loading) { if (tg.CloudStorage) tg.CloudStorage.setItem('toLearnSongs', JSON.stringify(toLearnSongs)); else localStorage.setItem('toLearnSongs', JSON.stringify(toLearnSongs)); } }, [toLearnSongs, loading]);
            useEffect(() => { if (!loading) { if (tg.CloudStorage) tg.CloudStorage.setItem('userProfile', JSON.stringify(userProfile)); else localStorage.setItem('userProfile', JSON.stringify(userProfile)); } }, [userProfile, loading]);
            useEffect(() => { if (!loading) { if (tg.CloudStorage) tg.CloudStorage.setItem('friends', JSON.stringify(friends)); else localStorage.setItem('friends', JSON.stringify(friends)); } }, [friends, loading]);
            useEffect(() => { if (!loading) { if (tg.CloudStorage) tg.CloudStorage.setItem('notes', JSON.stringify(notes)); else localStorage.setItem('notes', JSON.stringify(notes)); } }, [notes, loading]);

            const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const getDaysInMonth = (date) => { const year = date.getFullYear(), month = date.getMonth(); return { daysInMonth: new Date(year, month + 1, 0).getDate(), startingDayOfWeek: new Date(year, month, 1).getDay() }; };
            const getTotalMinutes = (dateKey) => practiceData[dateKey]?.entries?.reduce((sum, e) => sum + (e.minutes || 0), 0) || 0;
            const calculateStreak = () => { const today = new Date(); today.setHours(0, 0, 0, 0); let streak = 0, currentDate = new Date(today); while (getTotalMinutes(formatDateKey(currentDate)) > 0) { streak++; currentDate.setDate(currentDate.getDate() - 1); } return streak; };
            const getTotalPracticeMinutes = () => Object.keys(practiceData).reduce((sum, key) => sum + getTotalMinutes(key), 0);
            const getMinutesThisWeek = () => { const today = new Date(), start = new Date(today); start.setDate(today.getDate() - today.getDay()); start.setHours(0, 0, 0, 0); let total = 0; for (let d = new Date(start); d <= today; d.setDate(d.getDate() + 1)) total += getTotalMinutes(formatDateKey(d)); return total; };
            const getMinutesThisMonth = () => { const today = new Date(), start = new Date(today.getFullYear(), today.getMonth(), 1); let total = 0; for (let d = new Date(start); d <= today; d.setDate(d.getDate() + 1)) total += getTotalMinutes(formatDateKey(d)); return total; };
            const getCategoryMinutes = (cat) => Object.values(practiceData).reduce((sum, day) => sum + (day.entries?.filter(e => e.category === cat).reduce((s, e) => s + (e.minutes || 0), 0) || 0), 0);
            const getTechniqueMinutes = (tech) => Object.values(practiceData).reduce((sum, day) => sum + (day.entries?.filter(e => e.category === 'techniques' && e.selectedTechniques?.includes(tech)).reduce((s, e) => s + (e.minutes || 0), 0) || 0), 0);
            const getTop3Techniques = () => subcategories.techniques.map(t => ({ name: t, minutes: getTechniqueMinutes(t) })).filter(t => t.minutes > 0).sort((a, b) => b.minutes - a.minutes).slice(0, 3);
            const getSortedCategories = () => Object.entries(categories).map(([key, cat]) => ({ key, ...cat, minutes: getCategoryMinutes(key) })).sort((a, b) => b.minutes - a.minutes);
            
            const checkTimeBasedAchievement = (startHour, endHour) => Object.keys(practiceData).some(k => practiceData[k].entries?.some(e => { const h = new Date(e.timestamp).getHours(); return startHour < endHour ? (h >= startHour && h < endHour) : (h >= startHour || h < endHour); }));
            const checkMarathonDay = (mins) => Object.keys(practiceData).some(k => getTotalMinutes(k) >= mins);
            const checkWeeklyMarathon = () => { const today = new Date(); for (let w = 0; w < 52; w++) { let valid = true; for (let d = 0; d < 7; d++) { const date = new Date(today); date.setDate(today.getDate() - w * 7 - d); if (getTotalMinutes(formatDateKey(date)) < 120) { valid = false; break; } } if (valid) return true; } return false; };
            const checkFullCycle = () => Object.keys(practiceData).some(k => new Set(practiceData[k].entries?.map(e => e.category)).size === 6);
            const checkAllTechniquesWeek = () => { const today = new Date(), used = new Set(); for (let d = 0; d < 7; d++) { const date = new Date(today); date.setDate(today.getDate() - d); practiceData[formatDateKey(date)]?.entries?.forEach(e => e.selectedTechniques?.forEach(t => used.add(t))); } return used.size === subcategories.techniques.length; };

            const achievementDescriptions = {
                'streak_10': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤',
                'streak_30': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤',
                'streak_100': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 100 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤',
                'streak_365': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 365 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ - —Ü–µ–ª—ã–π –≥–æ–¥!',
                'streak_500': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 500 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥',
                'streak_1000': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 1000 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ - –ª–µ–≥–µ–Ω–¥–∞!',
                'night_owl': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è –º–µ–∂–¥—É 22:00 –∏ 4:00',
                'early_bird': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è –º–µ–∂–¥—É 6:00 –∏ 9:00',
                'marathon_2h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 2 —á–∞—Å–∞ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å',
                'marathon_3h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 3 —á–∞—Å–∞ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å',
                'marathon_4h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 4 —á–∞—Å–∞ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å',
                'weekly_marathon': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è –ø–æ 2 —á–∞—Å–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏',
                'full_cycle': '–ò—Å–ø–æ–ª—å–∑—É–π –≤—Å–µ 6 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å',
                'perfectionist': '–û—Ç—Ä–∞–±–æ—Ç–∞–π –≤—Å–µ 8 —Ç–µ—Ö–Ω–∏–∫ –∑–∞ –æ–¥–Ω—É –Ω–µ–¥–µ–ª—é',
                'first_friend': '–î–æ–±–∞–≤—å —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –¥—Ä—É–≥–∞',
                'technique_1h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π —Ç–µ—Ö–Ω–∏–∫—É 1 —á–∞—Å —Å—É–º–º–∞—Ä–Ω–æ',
                'technique_10h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π —Ç–µ—Ö–Ω–∏–∫—É 10 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'technique_100h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π —Ç–µ—Ö–Ω–∏–∫—É 100 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'improv_1h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—é 1 —á–∞—Å —Å—É–º–º–∞—Ä–Ω–æ',
                'improv_10h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—é 10 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'improv_100h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—é 100 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'theory_1h': '–ò–∑—É—á–∞–π —Ç–µ–æ—Ä–∏—é 1 —á–∞—Å —Å—É–º–º–∞—Ä–Ω–æ',
                'theory_10h': '–ò–∑—É—á–∞–π —Ç–µ–æ—Ä–∏—é 10 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'theory_100h': '–ò–∑—É—á–∞–π —Ç–µ–æ—Ä–∏—é 100 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'songs_1h': '–ò–≥—Ä–∞–π –ø–µ—Å–Ω–∏ 1 —á–∞—Å —Å—É–º–º–∞—Ä–Ω–æ',
                'songs_10h': '–ò–≥—Ä–∞–π –ø–µ—Å–Ω–∏ 10 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'songs_100h': '–ò–≥—Ä–∞–π –ø–µ—Å–Ω–∏ 100 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'ear_1h': '–†–∞–∑–≤–∏–≤–∞–π —Å–ª—É—Ö 1 —á–∞—Å —Å—É–º–º–∞—Ä–Ω–æ',
                'ear_10h': '–†–∞–∑–≤–∏–≤–∞–π —Å–ª—É—Ö 10 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'ear_100h': '–†–∞–∑–≤–∏–≤–∞–π —Å–ª—É—Ö 100 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'other_1h': '–ó–∞–Ω–∏–º–∞–π—Å—è –ø—Ä–æ—á–∏–º 1 —á–∞—Å —Å—É–º–º–∞—Ä–Ω–æ',
                'other_10h': '–ó–∞–Ω–∏–º–∞–π—Å—è –ø—Ä–æ—á–∏–º 10 —á–∞—Å–æ–≤ —Å—É–º–º–∞—Ä–Ω–æ',
                'total_100h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 100 —á–∞—Å–æ–≤ –≤ —Å—É–º–º–µ',
                'total_500h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 500 —á–∞—Å–æ–≤ –≤ —Å—É–º–º–µ',
                'total_1000h': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Å—è 1000 —á–∞—Å–æ–≤ –≤ —Å—É–º–º–µ',
                'collector_3': '–ü–æ–ª—É—á–∏ 3 –¥—Ä—É–≥–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
                'collector_10': '–ü–æ–ª—É—á–∏ 10 –¥—Ä—É–≥–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π',
                'collector_20': '–ü–æ–ª—É—á–∏ 20 –¥—Ä—É–≥–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π',
                'collector_30': '–ü–æ–ª—É—á–∏ 30 –¥—Ä—É–≥–∏—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π'
            };

            const achievements = [
                { id: 'streak_10', name: '10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üî•', type: 'streak', threshold: 10 },
                { id: 'streak_30', name: '30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: '‚ö°', type: 'streak', threshold: 30 },
                { id: 'streak_100', name: '100 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üíé', type: 'streak', threshold: 100 },
                { id: 'streak_365', name: '–ì–æ–¥ –ø—Ä–∞–∫—Ç–∏–∫–∏', icon: 'üëë', type: 'streak', threshold: 365 },
                { id: 'streak_500', name: '500 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üåü', type: 'streak', threshold: 500 },
                { id: 'streak_1000', name: '1000 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üèÜ', type: 'streak', threshold: 1000 },
                { id: 'night_owl', name: '–ù–æ—á–Ω–∞—è —Å–æ–≤–∞', icon: 'ü¶â', checkFunc: () => checkTimeBasedAchievement(22, 4) },
                { id: 'early_bird', name: '–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫', icon: 'üê¶', checkFunc: () => checkTimeBasedAchievement(6, 9) },
                { id: 'marathon_2h', name: '–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü 2—á', icon: 'üèÉ', checkFunc: () => checkMarathonDay(120) },
                { id: 'marathon_3h', name: '–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü 3—á', icon: 'üèÉ‚Äç‚ôÇÔ∏è', checkFunc: () => checkMarathonDay(180) },
                { id: 'marathon_4h', name: '–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü 4—á', icon: 'üèÉ‚Äç‚ôÄÔ∏è', checkFunc: () => checkMarathonDay(240) },
                { id: 'weekly_marathon', name: '–¢–µ—Ä–ø–µ–Ω–∏–µ –∏ —Ç—Ä—É–¥', icon: 'üí™', checkFunc: checkWeeklyMarathon },
                { id: 'full_cycle', name: '–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª', icon: 'üîÑ', checkFunc: checkFullCycle },
                { id: 'perfectionist', name: '–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç', icon: '‚ú®', checkFunc: checkAllTechniquesWeek },
                { id: 'first_friend', name: '–ü–µ—Ä–≤—ã–π –¥—Ä—É–≥', icon: 'üë•', checkFunc: () => friends.length >= 1 },
                { id: 'technique_1h', name: '–¢–µ—Ö–Ω–∏–∫–∞: 1 —á–∞—Å', icon: '‚ö°', type: 'techniques', threshold: 60 },
                { id: 'technique_10h', name: '–¢–µ—Ö–Ω–∏–∫–∞: 10 —á–∞—Å–æ–≤', icon: 'üé∏', type: 'techniques', threshold: 600 },
                { id: 'technique_100h', name: '–¢–µ—Ö–Ω–∏–∫–∞: 100 —á–∞—Å–æ–≤', icon: 'üî•', type: 'techniques', threshold: 6000 },
                { id: 'improv_1h', name: '–ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è: 1 —á–∞—Å', icon: 'üéµ', type: 'improvisation', threshold: 60 },
                { id: 'improv_10h', name: '–ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è: 10 —á–∞—Å–æ–≤', icon: 'üéº', type: 'improvisation', threshold: 600 },
                { id: 'improv_100h', name: '–ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è: 100 —á–∞—Å–æ–≤', icon: 'üèÜ', type: 'improvisation', threshold: 6000 },
                { id: 'theory_1h', name: '–¢–µ–æ—Ä–∏—è: 1 —á–∞—Å', icon: 'üìö', type: 'theory', threshold: 60 },
                { id: 'theory_10h', name: '–¢–µ–æ—Ä–∏—è: 10 —á–∞—Å–æ–≤', icon: 'üìñ', type: 'theory', threshold: 600 },
                { id: 'theory_100h', name: '–¢–µ–æ—Ä–∏—è: 100 —á–∞—Å–æ–≤', icon: 'üéì', type: 'theory', threshold: 6000 },
                { id: 'songs_1h', name: '–ü–µ—Å–Ω–∏: 1 —á–∞—Å', icon: 'üéµ', type: 'songs', threshold: 60 },
                { id: 'songs_10h', name: '–ü–µ—Å–Ω–∏: 10 —á–∞—Å–æ–≤', icon: 'üé§', type: 'songs', threshold: 600 },
                { id: 'songs_100h', name: '–ü–µ—Å–Ω–∏: 100 —á–∞—Å–æ–≤', icon: 'üåü', type: 'songs', threshold: 6000 },
                { id: 'ear_1h', name: '–°–ª—É—Ö: 1 —á–∞—Å', icon: 'üëÇ', type: 'earTraining', threshold: 60 },
                { id: 'ear_10h', name: '–°–ª—É—Ö: 10 —á–∞—Å–æ–≤', icon: 'üéß', type: 'earTraining', threshold: 600 },
                { id: 'ear_100h', name: '–°–ª—É—Ö: 100 —á–∞—Å–æ–≤', icon: 'üé∂', type: 'earTraining', threshold: 6000 },
                { id: 'other_1h', name: '–ü—Ä–æ—á–µ–µ: 1 —á–∞—Å', icon: 'üéº', type: 'other', threshold: 60 },
                { id: 'other_10h', name: '–ü—Ä–æ—á–µ–µ: 10 —á–∞—Å–æ–≤', icon: 'üéπ', type: 'other', threshold: 600 },
                { id: 'total_100h', name: '–í—Å–µ–≥–æ: 100 —á–∞—Å–æ–≤', icon: '‚≠ê', checkFunc: () => getTotalPracticeMinutes() >= 6000 },
                { id: 'total_500h', name: '–í—Å–µ–≥–æ: 500 —á–∞—Å–æ–≤', icon: 'üí´', checkFunc: () => getTotalPracticeMinutes() >= 30000 },
                { id: 'total_1000h', name: '–í—Å–µ–≥–æ: 1000 —á–∞—Å–æ–≤', icon: 'üèÜ', checkFunc: () => getTotalPracticeMinutes() >= 60000 },
                { id: 'collector_3', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä: 3', icon: 'üèÖ', checkFunc: () => false },
                { id: 'collector_10', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä: 10', icon: 'üèÖ', checkFunc: () => false },
                { id: 'collector_20', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä: 20', icon: 'üèÖ', checkFunc: () => false },
                { id: 'collector_30', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä: 30', icon: 'üèÖ', checkFunc: () => false }
            ];

            const getUnlockedAchievements = () => { 
                const streak = calculateStreak(); 
                const unlocked = achievements.filter(a => {
                    if (a.id.startsWith('collector_')) return false;
                    return a.checkFunc ? a.checkFunc() : a.type === 'streak' ? streak >= a.threshold : a.technique ? getTechniqueMinutes(a.technique) >= a.threshold : getCategoryMinutes(a.type) >= a.threshold;
                });
                const count = unlocked.length;
                if (count >= 3) unlocked.push(achievements.find(a => a.id === 'collector_3'));
                if (count >= 10) unlocked.push(achievements.find(a => a.id === 'collector_10'));
                if (count >= 20) unlocked.push(achievements.find(a => a.id === 'collector_20'));
                if (count >= 30) unlocked.push(achievements.find(a => a.id === 'collector_30'));
                return unlocked.filter(Boolean);
            };
            
            const savePracticeEntry = (category, minutes, details, sourceLink, selectedTechniques, selectedApproaches, tempo) => {
                const dateKey = formatDateKey(selectedDate);
                setPracticeData(prev => ({ ...prev, [dateKey]: { ...prev[dateKey], entries: [...(prev[dateKey]?.entries || []), { id: Date.now(), category, minutes: parseInt(minutes), details, sourceLink, selectedTechniques, selectedApproaches, tempo, timestamp: new Date().toISOString() }] } }));
            };

            const deleteEntry = (dateKey, entryId) => {
                if ((tg.showConfirm && tg.showConfirm('–£–¥–∞–ª–∏—Ç—å?', () => {})) || confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                    setPracticeData(prev => { const newData = { ...prev }; if (newData[dateKey]) { newData[dateKey].entries = newData[dateKey].entries.filter(e => e.id !== entryId); if (newData[dateKey].entries.length === 0) delete newData[dateKey]; } return newData; });
                }
            };

            const handleDateClick = (day) => { setSelectedDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), day)); setShowModal(true); setShowAddForm(false); };

            const renderCalendar = () => {
                const { daysInMonth, startingDayOfWeek } = getDaysInMonth(currentDate);
                const days = [];
                ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'].forEach(d => days.push(<div key={`h-${d}`} className="text-center font-semibold text-gray-600 p-2 text-xs">{d}</div>));
                for (let i = 0; i < startingDayOfWeek; i++) days.push(<div key={`e-${i}`} className="p-2"></div>);
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = formatDateKey(new Date(currentDate.getFullYear(), currentDate.getMonth(), day));
                    const totalMinutes = getTotalMinutes(dateKey);
                    days.push(
                        <div key={day} onClick={() => handleDateClick(day)} className={`p-2 border rounded-lg cursor-pointer h-16 flex flex-col ${totalMinutes > 0 ? 'bg-gradient-to-br from-amber-50 to-orange-50 border-orange-200' : 'border-gray-200'}`}>
                            <div className="font-semibold text-gray-700 text-xs">{day}</div>
                            {totalMinutes > 0 && <div className="text-xs mt-auto text-orange-600 font-semibold">{totalMinutes}–º</div>}
                        </div>
                    );
                }
                return days;
            };

            const PracticeModal = () => {
                const [activeCategory, setActiveCategory] = useState('techniques');
                const [minutes, setMinutes] = useState('');
                const [modalNotes, setModalNotes] = useState('');
                const [sourceLink, setSourceLink] = useState('');
                const [selectedSubcategories, setSelectedSubcategories] = useState([]);
                const [tempo, setTempo] = useState('');
                
                if (!showModal || !selectedDate) return null;
                const dateKey = formatDateKey(selectedDate);
                const existingEntries = practiceData[dateKey]?.entries || [];
                
                const handleSave = () => {
                    if (!minutes) return alert('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è');
                    let details = modalNotes;
                    let subcatsToSave = selectedSubcategories.length > 0 ? selectedSubcategories : [];
                    
                    if (selectedSubcategories.length > 0) {
                        details = `${selectedSubcategories.join(', ')}${modalNotes ? ' | ' + modalNotes : ''}`;
                    }
                    
                    if (activeCategory === 'techniques' && tempo) {
                        details += ` | –¢–µ–º–ø: ${tempo} bpm`;
                    }
                    
                    savePracticeEntry(activeCategory, minutes, details, sourceLink, subcatsToSave, [], tempo || '');
                    setMinutes(''); setModalNotes(''); setSourceLink(''); setSelectedSubcategories([]); setTempo(''); setShowAddForm(false);
                };
                
                const currentSubcategories = subcategories[activeCategory] || [];
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="bg-gradient-to-r from-purple-600 to-orange-600 text-white p-4 flex justify-between rounded-t-xl">
                                <h2 className="text-lg font-bold">{selectedDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}</h2>
                                <button onClick={() => { setShowModal(false); setShowAddForm(false); }} className="text-2xl">‚úï</button>
                            </div>
                            <div className="p-4">
                                {existingEntries.length > 0 && !showAddForm && (
                                    <div className="mb-4">
                                        <h3 className="font-bold text-sm mb-3">–ó–∞–ø–∏—Å–∏ ({existingEntries.length})</h3>
                                        {existingEntries.map(entry => (
                                            <div key={entry.id} className="mb-3 p-3 bg-gray-50 rounded-lg text-sm">
                                                <div className="flex justify-between">
                                                    <div>
                                                        <div className="font-semibold">{categories[entry.category]?.icon} {entry.minutes} –º–∏–Ω</div>
                                                        {entry.details && <div className="text-xs text-gray-600 mt-1">{entry.details}</div>}
                                                        {entry.sourceLink && <a href={entry.sourceLink} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline">üîó –°—Å—ã–ª–∫–∞</a>}
                                                    </div>
                                                    <button onClick={() => deleteEntry(dateKey, entry.id)} className="text-red-500">‚úï</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {!showAddForm && (
                                    <button onClick={() => setShowAddForm(true)} className="w-full py-3 bg-gradient-to-r from-purple-600 to-orange-600 text-white rounded-lg font-bold text-lg">
                                        + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É
                                    </button>
                                )}
                                
                                {showAddForm && (
                                    <>
                                        <div className="flex gap-2 mb-4 overflow-x-auto">
                                            {Object.entries(categories).map(([key, cat]) => (
                                                <button key={key} onClick={() => { setActiveCategory(key); setSelectedSubcategories([]); }} className={`px-3 py-2 rounded-lg text-xs whitespace-nowrap ${activeCategory === key ? `${cat.color} text-white` : 'bg-gray-100'}`}>
                                                    {cat.icon} {cat.name}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="space-y-3">
                                            <input type="number" value={minutes} onChange={(e) => setMinutes(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="–ú–∏–Ω—É—Ç—ã" />
                                            
                                            {currentSubcategories.length > 0 && (
                                                <div className="max-h-32 overflow-y-auto border rounded-lg p-2">
                                                    {currentSubcategories.map(subcat => (
                                                        <label key={subcat} className="flex items-center gap-2 p-1 text-xs cursor-pointer">
                                                            <input type="checkbox" checked={selectedSubcategories.includes(subcat)} onChange={(e) => setSelectedSubcategories(e.target.checked ? [...selectedSubcategories, subcat] : selectedSubcategories.filter(s => s !== subcat))} />
                                                            <span>{subcat}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {activeCategory === 'techniques' && (
                                                <input type="number" value={tempo} onChange={(e) => setTempo(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="–¢–µ–º–ø (BPM)" />
                                            )}
                                            
                                            <textarea value={modalNotes} onChange={(e) => setModalNotes(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" rows="2" placeholder="–ó–∞–º–µ—Ç–∫–∏"></textarea>
                                            <input type="url" value={sourceLink} onChange={(e) => setSourceLink(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="–°—Å—ã–ª–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
                                            <div className="flex gap-2">
                                                <button onClick={handleSave} className="flex-1 bg-gradient-to-r from-purple-600 to-orange-600 text-white py-3 rounded-lg font-bold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                                <button onClick={() => setShowAddForm(false)} className="px-4 bg-gray-300 text-gray-700 rounded-lg font-bold">–û—Ç–º–µ–Ω–∞</button>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const CalendarView = () => {
                const top3 = getTop3Techniques();
                const sorted = getSortedCategories();
                return (
                    <>
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                            <div className="flex justify-between items-center">
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm">‚Üê</button>
                                <h2 className="text-xl font-bold">{['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'][currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
                                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="px-3 py-2 bg-orange-600 text-white rounded-lg text-sm">‚Üí</button>
                            </div>
                        </div>
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4"><div className="grid grid-cols-7 gap-1">{renderCalendar()}</div></div>
                        <div className="bg-gradient-to-r from-purple-100 to-orange-100 rounded-xl p-4 mb-4 text-center">
                            <div className="text-xs text-gray-600 mb-1">üí≠ –ú–æ—Ç–∏–≤–∞—Ü–∏—è –¥–Ω—è</div>
                            <div className="text-sm font-semibold italic">"{dailyQuote}"</div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <h3 className="text-lg font-bold mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                                <div className="space-y-2">
                                    <div className="flex items-center gap-2 p-2 bg-gradient-to-r from-orange-50 to-red-50 rounded-lg">
                                        <span className="text-2xl">üî•</span>
                                        <div><div className="text-xs text-gray-600">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div><div className="text-lg font-bold text-orange-600">{calculateStreak()}</div></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div className="p-2 bg-blue-50 rounded-lg"><div className="text-xs text-gray-600">–ó–∞ –Ω–µ–¥–µ–ª—é</div><div className="text-base font-bold text-blue-600">{getMinutesThisWeek()}–º</div></div>
                                        <div className="p-2 bg-indigo-50 rounded-lg"><div className="text-xs text-gray-600">–ó–∞ –º–µ—Å—è—Ü</div><div className="text-base font-bold text-indigo-600">{getMinutesThisMonth()}–º</div></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div className="p-2 bg-green-50 rounded-lg"><div className="text-xs text-gray-600">–°—Ä–µ–¥–Ω–µ–µ/–¥–µ–Ω—å (–Ω–µ–¥)</div><div className="text-base font-bold text-green-600">{Math.round(getMinutesThisWeek() / 7)}–º</div></div>
                                        <div className="p-2 bg-teal-50 rounded-lg"><div className="text-xs text-gray-600">–°—Ä–µ–¥–Ω–µ–µ/–¥–µ–Ω—å (–º–µ—Å)</div><div className="text-base font-bold text-teal-600">{Math.round(getMinutesThisMonth() / new Date().getDate())}–º</div></div>
                                    </div>
                                    {top3.length > 0 && (
                                        <div className="p-2 bg-purple-50 rounded-lg">
                                            <div className="text-xs text-gray-600 mb-1 font-semibold">üéØ –¢–æ–ø-3 —Å–∞–º—ã—Ö —á–∞—Å—Ç—ã—Ö —Ç–µ—Ö–Ω–∏–∫:</div>
                                            {top3.map((t, i) => <div key={t.name} className="text-xs">{i + 1}. {t.name} - <span className="font-bold">{t.minutes}–º</span></div>)}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <h3 className="text-lg font-bold mb-3">üéØ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                                <div className="space-y-2">
                                    {sorted.map(cat => (
                                        <div key={cat.key} className="p-2 bg-gray-50 rounded-lg">
                                            <div className="flex justify-between mb-1">
                                                <div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${cat.color}`}></div><span className="text-xs font-semibold">{cat.icon} {cat.name}</span></div>
                                                <span className="text-xs text-gray-500">{Math.floor(cat.minutes / 60)}—á {cat.minutes % 60}–º</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-1"><div className={`${cat.color} h-1 rounded-full`} style={{ width: `${Math.min((cat.minutes / (getTotalPracticeMinutes() || 1)) * 100, 100)}%` }}></div></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </>
                );
            };

            const AchievementsView = () => {
                const unlocked = getUnlockedAchievements();
                return (
                    <div className="bg-white rounded-xl shadow-lg p-4">
                        <h3 className="text-xl font-bold mb-4">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è ({unlocked.length}/{achievements.length})</h3>
                        <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
                            {achievements.map(a => {
                                const isUnlocked = unlocked.some(u => u.id === a.id);
                                return (
                                    <div key={a.id} onClick={() => setSelectedAchievement(a)} className={`p-2 rounded-lg text-center cursor-pointer ${isUnlocked ? 'bg-gradient-to-br from-yellow-100 to-orange-100 border-2 border-yellow-400' : 'bg-gray-100 opacity-40 grayscale'}`}>
                                        <div className="text-2xl mb-1">{a.icon}</div>
                                        <div className="text-xs font-semibold leading-tight">{a.name}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const NotesView = () => {
                const [newLearned, setNewLearned] = useState('');
                const [newLearnedLink, setNewLearnedLink] = useState('');
                const [newToLearn, setNewToLearn] = useState('');
                const [currentTempo, setCurrentTempo] = useState('');
                const [targetTempo, setTargetTempo] = useState('');
                const [newNote, setNewNote] = useState('');
                
                const addNote = () => {
                    if (newNote.trim()) {
                        setNotes([...notes, { id: Date.now(), text: newNote, date: new Date().toISOString() }]);
                        setNewNote('');
                    }
                };
                
                const deleteNote = (id) => setNotes(notes.filter(n => n.id !== id));
                
                const saveEditedNote = (id, newText) => {
                    setNotes(notes.map(n => n.id === id ? { ...n, text: newText } : n));
                    setEditingNote(null);
                };
                
                return (
                    <div className="space-y-4">
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <h3 className="text-lg font-bold mb-3">üìù –û–±—â–∏–µ –∑–∞–º–µ—Ç–∫–∏ ({notes.length})</h3>
                            <div className="space-y-2 mb-3 max-h-60 overflow-y-auto">
                                {notes.map(note => (
                                    <div key={note.id} className="p-2 bg-gray-50 rounded-lg">
                                        {editingNote === note.id ? (
                                            <div className="flex gap-2">
                                                <textarea value={note.text} onChange={(e) => setNotes(notes.map(n => n.id === note.id ? { ...n, text: e.target.value } : n))} className="flex-1 px-2 py-1 border rounded text-sm" rows="2" />
                                                <div className="flex flex-col gap-1">
                                                    <button onClick={() => saveEditedNote(note.id, note.text)} className="px-2 py-1 bg-green-600 text-white rounded text-xs">‚úì</button>
                                                    <button onClick={() => setEditingNote(null)} className="px-2 py-1 bg-gray-400 text-white rounded text-xs">‚úï</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="text-sm">{note.text}</div>
                                                    <div className="text-xs text-gray-500 mt-1">{new Date(note.date).toLocaleDateString('ru-RU')}</div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setEditingNote(note.id)} className="text-blue-600 text-sm">‚úèÔ∏è</button>
                                                    <button onClick={() => deleteNote(note.id)} className="text-red-500 text-sm">‚úï</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <textarea value={newNote} onChange={(e) => setNewNote(e.target.value)} placeholder="–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞" className="flex-1 px-3 py-2 border rounded-lg text-sm" rows="2" />
                                <button onClick={addNote} className="px-3 bg-purple-600 text-white rounded-lg">+</button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <h3 className="text-lg font-bold mb-3">‚úÖ –í—ã—É—á–µ–Ω–Ω—ã–µ ({learnedSongs.length})</h3>
                                <div className="space-y-2 mb-3 max-h-60 overflow-y-auto">
                                    {learnedSongs.map((s, i) => (
                                        <div key={i} className="p-2 bg-green-50 rounded-lg">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <span className="font-semibold text-sm">{s.name}</span>
                                                    {s.link && <a href={s.link} target="_blank" rel="noopener noreferrer" className="block text-xs text-blue-600 hover:underline mt-1">üîó –°—Å—ã–ª–∫–∞</a>}
                                                </div>
                                                <button onClick={() => setLearnedSongs(learnedSongs.filter((_, idx) => idx !== i))} className="text-red-500">‚úï</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="space-y-2">
                                    <input type="text" value={newLearned} onChange={(e) => setNewLearned(e.target.value)} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" className="w-full px-3 py-2 border rounded-lg text-sm" />
                                    <input type="url" value={newLearnedLink} onChange={(e) => setNewLearnedLink(e.target.value)} placeholder="–°—Å—ã–ª–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" className="w-full px-3 py-2 border rounded-lg text-sm" />
                                    <button onClick={() => newLearned && (setLearnedSongs([...learnedSongs, { name: newLearned, link: newLearnedLink, date: new Date().toISOString() }]), setNewLearned(''), setNewLearnedLink(''))} className="w-full px-3 py-2 bg-green-600 text-white rounded-lg text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <h3 className="text-lg font-bold mb-3">üéØ –ü–ª–∞–Ω–∏—Ä—É—é ({toLearnSongs.length})</h3>
                                <div className="space-y-2 mb-3 max-h-60 overflow-y-auto">
                                    {toLearnSongs.map((s, i) => (
                                        <div key={i} className="p-2 bg-blue-50 rounded-lg">
                                            <div className="flex justify-between mb-1">
                                                <span className="font-semibold text-sm">{s.name}</span>
                                                <button onClick={() => setToLearnSongs(toLearnSongs.filter((_, idx) => idx !== i))} className="text-red-500">‚úï</button>
                                            </div>
                                            <div className="text-xs text-gray-600">{s.currentTempo} ‚Üí {s.targetTempo} bpm</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="space-y-2">
                                    <input type="text" value={newToLearn} onChange={(e) => setNewToLearn(e.target.value)} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" className="w-full px-3 py-2 border rounded-lg text-sm" />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="number" value={currentTempo} onChange={(e) => setCurrentTempo(e.target.value)} placeholder="–¢–µ–∫—É—â–∏–π" className="px-3 py-2 border rounded-lg text-sm" />
                                        <input type="number" value={targetTempo} onChange={(e) => setTargetTempo(e.target.value)} placeholder="–¶–µ–ª—å" className="px-3 py-2 border rounded-lg text-sm" />
                                    </div>
                                    <button onClick={() => newToLearn && (setToLearnSongs([...toLearnSongs, { name: newToLearn, currentTempo: currentTempo || '0', targetTempo: targetTempo || '120', date: new Date().toISOString() }]), setNewToLearn(''), setCurrentTempo(''), setTargetTempo(''))} className="w-full px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const HistoryView = () => {
                const allPractices = Object.entries(practiceData)
                    .flatMap(([dateKey, day]) => day.entries?.map(entry => ({ ...entry, dateKey })) || [])
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                return (
                    <div className="bg-white rounded-xl shadow-lg p-4">
                        <h3 className="text-xl font-bold mb-4">üìú –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–∫—Ç–∏–∫–∏</h3>
                        <div className="space-y-2 max-h-[70vh] overflow-y-auto">
                            {allPractices.length === 0 && (
                                <div className="text-center text-gray-500 py-8">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø—Ä–∞–∫—Ç–∏–∫–µ</div>
                            )}
                            {allPractices.map(entry => (
                                <div key={entry.id} className="p-3 bg-gray-50 rounded-lg border-l-4" style={{ borderColor: categories[entry.category]?.color.replace('bg-', '#') }}>
                                    <div className="flex justify-between items-start mb-1">
                                        <div className="font-semibold text-sm">{categories[entry.category]?.icon} {categories[entry.category]?.name}</div>
                                        <div className="text-xs text-gray-500">{new Date(entry.timestamp).toLocaleDateString('ru-RU')}</div>
                                    </div>
                                    <div className="text-sm font-bold text-orange-600">{entry.minutes} –º–∏–Ω—É—Ç</div>
                                    {entry.details && <div className="text-xs text-gray-600 mt-1">{entry.details}</div>}
                                    {entry.sourceLink && <a href={entry.sourceLink} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline">üîó –°—Å—ã–ª–∫–∞</a>}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const ProfileView = () => {
                const [editingName, setEditingName] = useState(false);
                const [newName, setNewName] = useState(userProfile.username);
                const [localSearchName, setLocalSearchName] = useState('');
                const unlocked = getUnlockedAchievements();
                
                const addFriend = () => {
                    const trimmedName = localSearchName.trim();
                    if (!trimmedName) {
                        if (tg.showAlert) tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return;
                    }
                    if (friends.some(f => f.username.toLowerCase() === trimmedName.toLowerCase())) {
                        if (tg.showAlert) tg.showAlert('–≠—Ç–æ—Ç –¥—Ä—É–≥ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω!');
                        return;
                    }
                    if (trimmedName.toLowerCase() === userProfile.username.toLowerCase()) {
                        if (tg.showAlert) tg.showAlert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!');
                        return;
                    }
                    setFriends([...friends, { username: trimmedName, since: new Date().toISOString() }]);
                    if (tg.showAlert) tg.showAlert(`–î—Ä—É–≥ ${trimmedName} –¥–æ–±–∞–≤–ª–µ–Ω!`);
                    setLocalSearchName('');
                };
                
                return (
                    <div className="space-y-4">
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <div className="flex items-center gap-4 mb-4">
                                <div className="w-16 h-16 bg-gradient-to-br from-purple-600 to-orange-600 rounded-full flex items-center justify-center text-white text-2xl font-bold overflow-hidden">
                                    {userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" alt="Avatar" /> : userProfile.username[0]?.toUpperCase()}
                                </div>
                                <div className="flex-1">
                                    {editingName ? (
                                        <div className="flex gap-2">
                                            <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} className="flex-1 px-3 py-2 border rounded-lg text-sm" />
                                            <button onClick={() => {setUserProfile({...userProfile, username: newName}); setEditingName(false);}} className="px-3 py-2 bg-green-600 text-white rounded-lg text-sm">‚úì</button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-2">
                                            <h2 className="text-xl font-bold">{userProfile.username}</h2>
                                            <button onClick={() => setEditingName(true)} className="text-blue-600 text-sm">‚úèÔ∏è</button>
                                        </div>
                                    )}
                                    <div className="text-xs text-gray-600">–° {new Date(userProfile.registrationDate).toLocaleDateString('ru-RU')}</div>
                                </div>
                            </div>
                            <div className="grid grid-cols-3 gap-2 mb-4">
                                <div className="p-2 bg-orange-50 rounded-lg"><div className="text-xs text-gray-600">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div><div className="text-base font-bold text-orange-600">{calculateStreak()}</div></div>
                                <div className="p-2 bg-purple-50 rounded-lg"><div className="text-xs text-gray-600">–í—Å–µ–≥–æ</div><div className="text-base font-bold text-purple-600">{Math.floor(getTotalPracticeMinutes() / 60)}—á {getTotalPracticeMinutes() % 60}–º</div></div>
                                <div className="p-2 bg-blue-50 rounded-lg"><div className="text-xs text-gray-600">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div><div className="text-base font-bold text-blue-600">{unlocked.length}/{achievements.length}</div></div>
                            </div>
                            <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div><div className="font-semibold text-sm">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div><div className="text-xs text-gray-600">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div></div>
                                <label className="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked={darkTheme} onChange={(e) => setDarkTheme(e.target.checked)} className="sr-only peer" />
                                    <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                        </div>
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <h3 className="text-lg font-bold mb-3">üë• –î—Ä—É–∑—å—è ({friends.length})</h3>
                            <div className="flex gap-2 mb-3">
                                <input type="text" value={localSearchName} onChange={(e) => setLocalSearchName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && addFriend()} placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" className="flex-1 px-3 py-2 border rounded-lg text-sm" />
                                <button onClick={addFriend} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm whitespace-nowrap">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                            {friends.length > 0 && (
                                <div className="space-y-2">
                                    {friends.map((friend, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <div className="flex-1">
                                                <div className="font-semibold text-sm">{friend.username}</div>
                                                <div className="text-xs text-gray-600">–î—Ä—É–∂–∏—Ç–µ —Å {new Date(friend.since).toLocaleDateString('ru-RU')}</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => setViewingFriend(friend)} className="px-3 py-1 bg-purple-600 text-white rounded text-xs">–ü—Ä–æ—Ñ–∏–ª—å</button>
                                                <button onClick={() => setFriends(friends.filter((_, i) => i !== idx))} className="text-red-500 text-sm px-2">‚úï</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {friends.length === 0 && <div className="text-center text-gray-500 text-sm py-4">–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π!</div>}
                        </div>
                    </div>
                );
            };

            const tabs = [
                { id: 'calendar', name: '–ö–∞–ª–µ–Ω–¥–∞—Ä—å', icon: 'üìÖ' },
                { id: 'achievements', name: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', icon: 'üèÜ' },
                { id: 'notes', name: '–ó–∞–º–µ—Ç–∫–∏', icon: 'üìù' },
                { id: 'history', name: '–ò—Å—Ç–æ—Ä–∏—è', icon: 'üìú' },
                { id: 'profile', name: '–ü—Ä–æ—Ñ–∏–ª—å', icon: 'üë§' }
            ];

            if (loading) return <div className="flex items-center justify-center h-screen"><div className="text-2xl">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div></div>;

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-orange-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                            <div className="flex justify-between items-center mb-3">
                                <h1 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-orange-600">üé∏ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ì–∏—Ç–∞—Ä–Ω–æ–π –ü—Ä–∞–∫—Ç–∏–∫–∏</h1>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-gradient-to-br from-purple-600 to-orange-600 rounded-full flex items-center justify-center text-white text-sm font-bold overflow-hidden">
                                        {userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" alt="Avatar" /> : userProfile.username[0]?.toUpperCase()}
                                    </div>
                                    <span className="text-sm font-semibold hidden md:inline">{userProfile.username}</span>
                                </div>
                            </div>
                            <div className="flex gap-2 overflow-x-auto">
                                {tabs.map(tab => (
                                    <button key={tab.id} onClick={() => setCurrentTab(tab.id)} className={`px-3 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${currentTab === tab.id ? 'bg-gradient-to-r from-purple-600 to-orange-600 text-white' : 'bg-gray-100'}`}>
                                        {tab.icon} {tab.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                        {currentTab === 'calendar' && <CalendarView />}
                        {currentTab === 'achievements' && <AchievementsView />}
                        {currentTab === 'notes' && <NotesView />}
                        {currentTab === 'history' && <HistoryView />}
                        {currentTab === 'profile' && <ProfileView />}
                    </div>
                    <PracticeModal />
                    {viewingFriend && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                                <div className="bg-gradient-to-r from-purple-600 to-orange-600 text-white p-4 flex justify-between rounded-t-xl">
                                    <h2 className="text-lg font-bold">–ü—Ä–æ—Ñ–∏–ª—å –¥—Ä—É–≥–∞</h2>
                                    <button onClick={() => setViewingFriend(null)} className="text-2xl">‚úï</button>
                                </div>
                                <div className="p-6">
                                    <div className="flex items-center gap-4 mb-6">
                                        <div className="w-16 h-16 bg-gradient-to-br from-purple-600 to-orange-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                            {viewingFriend.username[0]?.toUpperCase()}
                                        </div>
                                        <div>
                                            <h3 className="text-xl font-bold">{viewingFriend.username}</h3>
                                            <p className="text-sm text-gray-600">–î—Ä—É–∂–∏—Ç–µ —Å {new Date(viewingFriend.since).toLocaleDateString('ru-RU')}</p>
                                        </div>
                                    </div>
                                    <div className="bg-blue-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-gray-600 mb-2">üìä –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥—Ä—É–≥–∞</p>
                                        <p className="text-xs text-gray-500">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥—Ä—É–∑–µ–π —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
                                        <p className="text-xs text-gray-500 mt-2">–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö! üöÄ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {selectedAchievement && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                                <div className="bg-gradient-to-r from-purple-600 to-orange-600 text-white p-4 flex justify-between rounded-t-xl">
                                    <h2 className="text-lg font-bold">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</h2>
                                    <button onClick={() => setSelectedAchievement(null)} className="text-2xl">‚úï</button>
                                </div>
                                <div className="p-6 text-center">
                                    <div className="text-6xl mb-4">{selectedAchievement.icon}</div>
                                    <h3 className="text-xl font-bold mb-2">{selectedAchievement.name}</h3>
                                    <p className="text-sm text-gray-600 mb-4">{achievementDescriptions[selectedAchievement.id] || '–í—ã–ø–æ–ª–Ω–∏ —É—Å–ª–æ–≤–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è'}</p>
                                    {getUnlockedAchievements().some(a => a.id === selectedAchievement.id) ? (
                                        <div className="bg-green-50 text-green-700 py-2 px-4 rounded-lg font-semibold">‚úÖ –ü–æ–ª—É—á–µ–Ω–æ!</div>
                                    ) : (
                                        <div className="bg-gray-100 text-gray-600 py-2 px-4 rounded-lg">üîí –ü–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<GuitarPracticeApp />, document.getElementById('root'));
    </script>
</body>
</html>
