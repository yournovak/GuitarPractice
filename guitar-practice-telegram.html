<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üé∏ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ì–∏—Ç–∞—Ä–Ω–æ–π –ü—Ä–∞–∫—Ç–∏–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            overflow-x: hidden;
        }
        #root {
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const GuitarPracticeApp = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [practiceData, setPracticeData] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [currentTab, setCurrentTab] = useState('calendar');
            const [learnedSongs, setLearnedSongs] = useState([]);
            const [toLearnSongs, setToLearnSongs] = useState([]);
            const [dailyQuote, setDailyQuote] = useState('');
            const [loading, setLoading] = useState(true);

            const categories = {
                techniques: { name: '–¢–µ—Ö–Ω–∏–∫–∏', color: 'bg-orange-500', icon: '‚ö°' },
                songs: { name: '–ò–≥—Ä–∞ –ø–µ—Å–µ–Ω', color: 'bg-pink-500', icon: 'üéµ' },
                improvisation: { name: '–ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è', color: 'bg-purple-500', icon: 'üé∏' },
                earTraining: { name: '–†–∞–∑–≤–∏—Ç–∏–µ —Å–ª—É—Ö–∞', color: 'bg-blue-500', icon: 'üëÇ' },
                theory: { name: '–¢–µ–æ—Ä–∏—è –º—É–∑—ã–∫–∏', color: 'bg-green-500', icon: 'üìö' }
            };

            const techniques = [
                'Alternate Picking (–ü–®)', 'Sweep Picking (–°–≤–∏–ø)', 'Legato', 'Bending', 'Vibrato',
                'Tapping', 'String Skipping', 'Tremolo Picking', 'Economy Picking', 'Hybrid Picking'
            ];

            const theoryTopics = [
                '–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã', '–ú–∞–∂–æ—Ä–Ω–∞—è –≥–∞–º–º–∞', '–ú–∏–Ω–æ—Ä–Ω–∞—è –≥–∞–º–º–∞', '–ü–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞', '–õ–∞–¥—ã (Modes)',
                '–ê–∫–∫–æ—Ä–¥–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏', 'CAGED —Å–∏—Å—Ç–µ–º–∞', '–ê—Ä–ø–µ–¥–∂–∏–æ', '–°–µ–ø—Ç–∞–∫–∫–æ—Ä–¥—ã', '–ö–≤–∞—Ä—Ç–æ-–∫–≤–∏–Ω—Ç–æ–≤—ã–π –∫—Ä—É–≥'
            ];

            const practiceApproaches = ['–†–∞–±–æ—Ç–∞–ª –Ω–∞ —Ä–∞–∑–≥–æ–Ω', '–†–∞–±–æ—Ç–∞–ª —Å –ø—É–Ω–∫—Ç–∏—Ä–∞–º–∏', '–†–∞–±–æ—Ç–∞–ª —Å–ø–∏–¥-–±–µ—Ä—Å—Ç'];
            const songsApproaches = ['–ò–≥—Ä–∞–ª –≤—ã—É—á–µ–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª', '–£—á–∏–ª –Ω–æ–≤–æ–µ'];

            const motivationalQuotes = [
                "–ú—É–∑—ã–∫–∞ - —ç—Ç–æ —è–∑—ã–∫ –¥—É—à–∏, –∞ –≥–∏—Ç–∞—Ä–∞ - —Ç–≤–æ–π –≥–æ–ª–æ—Å.",
                "–ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ç–µ–±—è –∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É.",
                "–í–µ–ª–∏–∫–∏–µ –≥–∏—Ç–∞—Ä–∏—Å—Ç—ã –Ω–µ —Ä–æ–∂–¥–∞—é—Ç—Å—è - –æ–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫—É—é—Ç—Å—è.",
                "–ü—Ä–∞–∫—Ç–∏–∫–∞ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å, –∞ –Ω–µ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ.",
                "–ò–≥—Ä–∞–π –æ—Ç —Å–µ—Ä–¥—Ü–∞, —Ç–µ—Ö–Ω–∏–∫–∞ –ø—Ä–∏–¥—ë—Ç —Å–ª–µ–¥–æ–º.",
                "–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –±–µ—Ä—ë—à—å –≥–∏—Ç–∞—Ä—É, –∏–≥—Ä–∞–π –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑. ‚Äî Eric Clapton",
                "–£ —Ç–µ–±—è –≤—Å–µ–≥–æ 12 –Ω–æ—Ç. –î–µ–ª–∞–π —Å –Ω–∏–º–∏ —á—Ç–æ —Ö–æ—á–µ—à—å. ‚Äî Eddie Van Halen",
                "–ö —á—ë—Ä—Ç—É –ø—Ä–∞–≤–∏–ª–∞. –ï—Å–ª–∏ –∑–≤—É—á–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ - –∑–Ω–∞—á–∏—Ç —Ç–∞–∫ –∏ –µ—Å—Ç—å. ‚Äî Eddie Van Halen",
                "–î–∞–π –º–Ω–µ –≥–∏—Ç–∞—Ä—É, —Ñ–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ –∏–ª–∏ –º–µ—Ç–ª—É —Å–æ —Å—Ç—Ä—É–Ω–æ–π - –Ω–µ –∑–∞—Å–∫—É—á–∞—é –Ω–∏–≥–¥–µ. ‚Äî Keith Richards",
                "–†–∞—Å—Å–ª–∞–±—å—Å—è. –ë—É–¥—å —Å–æ–±–æ–π. –ò–≥—Ä–∞–π –º–Ω–æ–≥–æ. ‚Äî Joe Satriani",
                "–ì–∏—Ç–∞—Ä–∞ - –ª—É—á—à–∞—è —Ñ–æ—Ä–º–∞ —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –º–µ–Ω—è. ‚Äî Slash"
            ];

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram Cloud Storage
            useEffect(() => {
                const loadData = async () => {
                    try {
                        if (tg.CloudStorage) {
                            const keys = ['practiceData', 'learnedSongs', 'toLearnSongs'];
                            
                            tg.CloudStorage.getItems(keys, (error, result) => {
                                if (!error && result) {
                                    if (result.practiceData) setPracticeData(JSON.parse(result.practiceData));
                                    if (result.learnedSongs) setLearnedSongs(JSON.parse(result.learnedSongs));
                                    if (result.toLearnSongs) setToLearnSongs(JSON.parse(result.toLearnSongs));
                                }
                                setLoading(false);
                            });
                        } else {
                            setLoading(false);
                        }
                    } catch (e) {
                        console.error('Load error:', e);
                        setLoading(false);
                    }
                };
                
                loadData();
                setDailyQuote(motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]);
            }, []);

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Telegram Cloud Storage
            useEffect(() => {
                if (!loading && tg.CloudStorage) {
                    tg.CloudStorage.setItem('practiceData', JSON.stringify(practiceData));
                }
            }, [practiceData, loading]);

            useEffect(() => {
                if (!loading && tg.CloudStorage) {
                    tg.CloudStorage.setItem('learnedSongs', JSON.stringify(learnedSongs));
                }
            }, [learnedSongs, loading]);

            useEffect(() => {
                if (!loading && tg.CloudStorage) {
                    tg.CloudStorage.setItem('toLearnSongs', JSON.stringify(toLearnSongs));
                }
            }, [toLearnSongs, loading]);

            const formatDateKey = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };

            const getTotalMinutes = (dateKey) => {
                if (!practiceData[dateKey] || !practiceData[dateKey].entries) return 0;
                return practiceData[dateKey].entries.reduce((sum, entry) => sum + (entry.minutes || 0), 0);
            };

            const calculateStreak = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let streak = 0;
                let currentDate = new Date(today);

                while (true) {
                    const dateKey = formatDateKey(currentDate);
                    if (getTotalMinutes(dateKey) > 0) {
                        streak++;
                        currentDate.setDate(currentDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                return streak;
            };

            const handleDateClick = (day) => {
                const clickedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                setSelectedDate(clickedDate);
                setShowModal(true);
            };

            const savePracticeEntry = (category, minutes, notes, sourceLink, selectedItems, tempo) => {
                const dateKey = formatDateKey(selectedDate);
                const newEntry = {
                    id: Date.now(),
                    category,
                    minutes: parseInt(minutes),
                    notes,
                    sourceLink,
                    selectedItems,
                    tempo,
                    timestamp: new Date().toISOString()
                };

                setPracticeData(prev => ({
                    ...prev,
                    [dateKey]: {
                        ...prev[dateKey],
                        entries: [...(prev[dateKey]?.entries || []), newEntry]
                    }
                }));
                
                tg.showAlert('‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            };

            const deleteEntry = (dateKey, entryId) => {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?', (confirmed) => {
                    if (confirmed) {
                        setPracticeData(prev => {
                            const newData = { ...prev };
                            if (newData[dateKey] && newData[dateKey].entries) {
                                newData[dateKey].entries = newData[dateKey].entries.filter(e => e.id !== entryId);
                                if (newData[dateKey].entries.length === 0) {
                                    delete newData[dateKey];
                                }
                            }
                            return newData;
                        });
                    }
                });
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                return {
                    daysInMonth: lastDay.getDate(),
                    startingDayOfWeek: firstDay.getDay()
                };
            };

            const renderCalendar = () => {
                const { daysInMonth, startingDayOfWeek } = getDaysInMonth(currentDate);
                const days = [];
                const weekDays = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];

                weekDays.forEach(day => {
                    days.push(<div key={`header-${day}`} className="text-center font-semibold text-gray-600 p-2 text-sm">{day}</div>);
                });

                for (let i = 0; i < startingDayOfWeek; i++) {
                    days.push(<div key={`empty-${i}`} className="p-2"></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dateKey = formatDateKey(date);
                    const totalMinutes = getTotalMinutes(dateKey);
                    const hasData = practiceData[dateKey];

                    days.push(
                        <div
                            key={day}
                            onClick={() => handleDateClick(day)}
                            className={`p-2 border rounded-lg cursor-pointer active:bg-gray-100 transition-colors min-h-16 ${
                                hasData ? 'bg-gradient-to-br from-amber-50 to-orange-50 border-orange-200' : 'border-gray-200'
                            }`}
                        >
                            <div className="font-semibold text-gray-700 text-sm">{day}</div>
                            {totalMinutes > 0 && (
                                <div className="text-xs mt-1 text-orange-600 font-semibold">
                                    {totalMinutes}–º
                                </div>
                            )}
                        </div>
                    );
                }

                return days;
            };

            const PracticeModal = () => {
                const [activeCategory, setActiveCategory] = useState('techniques');
                const [minutes, setMinutes] = useState('');
                const [notes, setNotes] = useState('');
                const [sourceLink, setSourceLink] = useState('');
                const [selectedItems, setSelectedItems] = useState([]);
                const [tempo, setTempo] = useState('');

                if (!showModal || !selectedDate) return null;

                const dateKey = formatDateKey(selectedDate);
                const existingEntries = practiceData[dateKey]?.entries || [];

                const handleSave = () => {
                    if (!minutes) {
                        tg.showAlert('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏–∫–∏');
                        return;
                    }
                    savePracticeEntry(activeCategory, minutes, notes, sourceLink, selectedItems, tempo || '120');
                    setMinutes('');
                    setNotes('');
                    setSourceLink('');
                    setSelectedItems([]);
                    setTempo('');
                };

                const items = activeCategory === 'techniques' ? techniques : 
                              activeCategory === 'theory' ? theoryTopics : [];

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
                        <div className="bg-white rounded-t-3xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="sticky top-0 bg-gradient-to-r from-purple-600 to-orange-600 text-white p-4 rounded-t-3xl">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-lg font-bold">
                                        {selectedDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}
                                    </h2>
                                    <button onClick={() => setShowModal(false)} className="text-white text-2xl">‚úï</button>
                                </div>
                            </div>

                            <div className="p-4">
                                <div className="flex gap-2 mb-4 overflow-x-auto">
                                    {Object.entries(categories).map(([key, cat]) => (
                                        <button
                                            key={key}
                                            onClick={() => setActiveCategory(key)}
                                            className={`px-3 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                                                activeCategory === key ? `${cat.color} text-white` : 'bg-gray-100'
                                            }`}
                                        >
                                            {cat.icon} {cat.name}
                                        </button>
                                    ))}
                                </div>

                                <div className="space-y-3">
                                    <input
                                        type="number"
                                        value={minutes}
                                        onChange={(e) => setMinutes(e.target.value)}
                                        className="w-full px-4 py-3 border rounded-lg text-base"
                                        placeholder="–ú–∏–Ω—É—Ç—ã"
                                    />

                                    {items.length > 0 && (
                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                            {items.map(item => (
                                                <label key={item} className="flex items-center gap-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedItems.includes(item)}
                                                        onChange={(e) => {
                                                            if (e.target.checked) setSelectedItems([...selectedItems, item]);
                                                            else setSelectedItems(selectedItems.filter(i => i !== item));
                                                        }}
                                                        className="w-5 h-5"
                                                    />
                                                    <span className="text-sm">{item}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}

                                    {activeCategory === 'techniques' && (
                                        <input
                                            type="number"
                                            value={tempo}
                                            onChange={(e) => setTempo(e.target.value)}
                                            className="w-full px-4 py-3 border rounded-lg text-base"
                                            placeholder="–¢–µ–º–ø (BPM, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 120)"
                                        />
                                    )}

                                    <textarea
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        className="w-full px-4 py-3 border rounded-lg text-base"
                                        rows="3"
                                        placeholder="–ó–∞–º–µ—Ç–∫–∏..."
                                    />

                                    <input
                                        type="url"
                                        value={sourceLink}
                                        onChange={(e) => setSourceLink(e.target.value)}
                                        className="w-full px-4 py-3 border rounded-lg text-base"
                                        placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫"
                                    />

                                    <button
                                        onClick={handleSave}
                                        className="w-full bg-gradient-to-r from-purple-600 to-orange-600 text-white py-4 rounded-lg font-bold text-base"
                                    >
                                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                </div>

                                {existingEntries.length > 0 && (
                                    <div className="mt-4 space-y-3">
                                        <h3 className="font-bold">–ó–∞–ø–∏—Å–∏ ({existingEntries.length})</h3>
                                        {existingEntries.map(entry => (
                                            <div key={entry.id} className="p-3 bg-gray-50 rounded-lg">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="font-semibold text-sm">
                                                            {categories[entry.category]?.icon} {categories[entry.category]?.name}
                                                        </div>
                                                        <div className="text-sm text-gray-600">{entry.minutes} –º–∏–Ω</div>
                                                        {entry.notes && <div className="text-sm mt-1">{entry.notes}</div>}
                                                    </div>
                                                    <button
                                                        onClick={() => deleteEntry(dateKey, entry.id)}
                                                        className="text-red-500 text-lg ml-2"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

            if (loading) {
                return <div className="flex items-center justify-center h-screen">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-orange-50 p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                            <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-orange-600 bg-clip-text text-transparent mb-4">
                                üé∏ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ü—Ä–∞–∫—Ç–∏–∫–∏
                            </h1>
                            <div className="flex items-center justify-between mb-4">
                                <button
                                    onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))}
                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm"
                                >
                                    ‚Üê
                                </button>
                                <h2 className="text-lg font-bold">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</h2>
                                <button
                                    onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))}
                                    className="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm"
                                >
                                    ‚Üí
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                            <div className="grid grid-cols-7 gap-1">
                                {renderCalendar()}
                            </div>
                        </div>

                        <div className="bg-gradient-to-r from-purple-100 to-orange-100 rounded-xl shadow-lg p-4 mb-4">
                            <div className="text-center">
                                <div className="text-xs text-gray-600 mb-1">üí≠ –ú–æ—Ç–∏–≤–∞—Ü–∏—è –¥–Ω—è</div>
                                <div className="text-sm font-semibold text-gray-800 italic">"{dailyQuote}"</div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <div className="flex items-center gap-4">
                                <div className="flex-1">
                                    <div className="text-xs text-gray-600">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
                                    <div className="text-2xl font-bold text-orange-600">{calculateStreak()}</div>
                                </div>
                                <div className="text-4xl">üî•</div>
                            </div>
                        </div>
                    </div>

                    <PracticeModal />
                </div>
            );
        };

        ReactDOM.render(<GuitarPracticeApp />, document.getElementById('root'));
    </script>
</body>
</html>